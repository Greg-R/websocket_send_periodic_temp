<!DOCTYPE html>
<!-- saved from url=(0041)http://192.168.1.4/websocketweather2.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width">
<script src="./Temperature Visualization_files/d3.v4.min.js" type="text/javascript"></script>
<title>Temperature Visualization</title>
<style type="text/css">
body {
	margin: 20px;
}

.domain {
	display: none;
}

.tick line {
	stroke: #C0C0BB;
}

.tick text {
	fill: #8E8883;
	font-size: 14pt;
	font-family: sans-serif;
}

.axis-label {
	fill: #635F5D;
	font-family: sans-serif;
	font-size: 20pt;
}
</style>
</head>

<body>
	<div>
		<h2>Temperature Monitor</h2>
		<p id="connectstatus">WebSocket Connected</p>
	</div>
	<div>
		<p>Current Server Time in UTC</p>
		<h2>
			<div id="currentTime">Sunday October 29 13:30:00</div>
		</h2>
	</div>
	<svg width="960" height="500"><g transform="translate(120,20)"><g transform="translate(0, 360)" fill="none" font-size="10" font-family="sans-serif" text-anchor="middle"><text class="axis-label" x="405" y="50">Time</text><path class="domain" stroke="#000" d="M0.5,6V0.5H810.5V6"></path><g class="tick" opacity="1" transform="translate(5.24661875,0)"><line stroke="#000" y2="6"></line><text fill="#000" y="9" dy="0.71em">10:00</text></g><g class="tick" opacity="1" transform="translate(72.74661875,0)"><line stroke="#000" y2="6"></line><text fill="#000" y="9" dy="0.71em">11:00</text></g><g class="tick" opacity="1" transform="translate(140.24661874999998,0)"><line stroke="#000" y2="6"></line><text fill="#000" y="9" dy="0.71em">12:00</text></g><g class="tick" opacity="1" transform="translate(207.74661875,0)"><line stroke="#000" y2="6"></line><text fill="#000" y="9" dy="0.71em">01:00</text></g><g class="tick" opacity="1" transform="translate(275.24661875,0)"><line stroke="#000" y2="6"></line><text fill="#000" y="9" dy="0.71em">02:00</text></g><g class="tick" opacity="1" transform="translate(342.74661875000004,0)"><line stroke="#000" y2="6"></line><text fill="#000" y="9" dy="0.71em">03:00</text></g><g class="tick" opacity="1" transform="translate(410.24661875,0)"><line stroke="#000" y2="6"></line><text fill="#000" y="9" dy="0.71em">04:00</text></g><g class="tick" opacity="1" transform="translate(477.74661875000004,0)"><line stroke="#000" y2="6"></line><text fill="#000" y="9" dy="0.71em">05:00</text></g><g class="tick" opacity="1" transform="translate(545.2466187499999,0)"><line stroke="#000" y2="6"></line><text fill="#000" y="9" dy="0.71em">06:00</text></g><g class="tick" opacity="1" transform="translate(612.74661875,0)"><line stroke="#000" y2="6"></line><text fill="#000" y="9" dy="0.71em">07:00</text></g><g class="tick" opacity="1" transform="translate(680.24661875,0)"><line stroke="#000" y2="6"></line><text fill="#000" y="9" dy="0.71em">08:00</text></g><g class="tick" opacity="1" transform="translate(747.7466187499999,0)"><line stroke="#000" y2="6"></line><text fill="#000" y="9" dy="0.71em">09:00</text></g></g><g fill="none" font-size="10" font-family="sans-serif" text-anchor="end"><text class="axis-label" x="-180" y="-45" transform="rotate(-90)" style="text-anchor: middle;">Temperature</text><path class="domain" stroke="#000" d="M810,360.5H0.5V0.5H810"></path><g class="tick" opacity="1" transform="translate(0,360.5)"><line stroke="#000" x2="810"></line><text fill="#000" x="-15" dy="0.32em">50</text></g><g class="tick" opacity="1" transform="translate(0,324.5)"><line stroke="#000" x2="810"></line><text fill="#000" x="-15" dy="0.32em">55</text></g><g class="tick" opacity="1" transform="translate(0,288.5)"><line stroke="#000" x2="810"></line><text fill="#000" x="-15" dy="0.32em">60</text></g><g class="tick" opacity="1" transform="translate(0,252.5)"><line stroke="#000" x2="810"></line><text fill="#000" x="-15" dy="0.32em">65</text></g><g class="tick" opacity="1" transform="translate(0,216.5)"><line stroke="#000" x2="810"></line><text fill="#000" x="-15" dy="0.32em">70</text></g><g class="tick" opacity="1" transform="translate(0,180.5)"><line stroke="#000" x2="810"></line><text fill="#000" x="-15" dy="0.32em">75</text></g><g class="tick" opacity="1" transform="translate(0,144.5)"><line stroke="#000" x2="810"></line><text fill="#000" x="-15" dy="0.32em">80</text></g><g class="tick" opacity="1" transform="translate(0,108.50000000000003)"><line stroke="#000" x2="810"></line><text fill="#000" x="-15" dy="0.32em">85</text></g><g class="tick" opacity="1" transform="translate(0,72.5)"><line stroke="#000" x2="810"></line><text fill="#000" x="-15" dy="0.32em">90</text></g><g class="tick" opacity="1" transform="translate(0,36.5)"><line stroke="#000" x2="810"></line><text fill="#000" x="-15" dy="0.32em">95</text></g><g class="tick" opacity="1" transform="translate(0,0.5)"><line stroke="#000" x2="810"></line><text fill="#000" x="-15" dy="0.32em">100</text></g></g><path id="tempData" fill="none" stroke="steelblue" stroke-width="4" d="M5.62573125,181.44000000000003C5.62573125,181.44000000000003,9.4392625,179.52,11.34605625,178.56C13.25285,177.6,15.159693749999999,175.20000000000005,17.06649375,175.68000000000004C18.97329375,176.16000000000003,20.88009375,179.88000000000002,22.78685625,181.44000000000003C24.69361875,183.00000000000003,26.600312499999998,184.68000000000004,28.50706875,185.04000000000002C30.413825,185.4,32.32056875,184.44,34.22739375,183.6C36.134218749999995,182.76,38.041165625000005,181.08,39.94801875,180C41.854871875,178.92,43.761703125,176.87999999999994,45.6685125,177.11999999999995C47.575321875,177.35999999999996,49.482068749999996,179.88,51.388875,181.44000000000003C53.29568125,183.00000000000006,55.202471875,186.12000000000006,57.10935,186.48000000000005C59.016228125,186.84000000000003,60.923224999999995,184.68,62.83014375,183.6C64.7370625,182.51999999999998,66.64398750000001,181.08,68.55086250000001,180C70.45773750000001,178.92,72.36456875,177.83999999999995,74.27139375,177.11999999999995C76.17821875,176.39999999999995,78.08496249999999,174.96000000000004,79.9918125,175.68000000000004C81.8986625,176.40000000000003,83.80565312499999,179.40000000000003,85.71249375,181.44000000000003C87.619334375,183.48000000000002,89.52604062500001,187.55999999999997,91.43285625,187.91999999999996C93.339671875,188.27999999999994,95.24649062499999,184.92,97.1533875,183.6C99.060284375,182.28,100.967290625,180.84,102.8742375,180C104.78118437500001,179.16,106.688190625,178.56,108.59506875000001,178.56C110.50194687500002,178.56,112.40871250000001,180.24,114.31550625000001,180C116.22230000000002,179.76,118.12903750000001,175.79999999999995,120.03583125,177.11999999999995C121.94262499999999,178.43999999999994,123.84948750000001,186.11999999999995,125.75626875,187.91999999999996C127.66305,189.71999999999997,129.56975,188.87999999999997,131.47651875,187.91999999999996C133.3832875,186.95999999999995,135.29009374999998,183.71999999999997,137.19688125,182.15999999999997C139.10366875,180.59999999999997,141.01049374999997,179.16,142.91724374999998,178.56C144.82399375,177.96,146.73065937500002,178.8,148.63738125,178.56C150.544103125,178.32,152.45079687499998,176.51999999999995,154.357575,177.11999999999995C156.264353125,177.71999999999994,158.171234375,180.59999999999997,160.07805000000002,182.15999999999997C161.98486562500003,183.71999999999997,163.89166875,186.24000000000004,165.79846875,186.48000000000005C167.70526875000002,186.72000000000006,169.612034375,184.92000000000002,171.51885000000001,183.6C173.42566562500002,182.27999999999997,175.332621875,179.4,177.2393625,178.56C179.146103125,177.72,181.052590625,178.8,182.95929375,178.56C184.865996875,178.32,186.772803125,176.51999999999995,188.67958124999998,177.11999999999995C190.58635937499997,177.71999999999994,192.493184375,180.23999999999995,194.3999625,182.15999999999997C196.30674062499997,184.07999999999998,198.213440625,188.16,200.12025,188.64000000000001C202.027059375,189.12000000000003,203.93395312500002,186.48000000000002,205.84081875,185.04000000000002C207.747684375,183.60000000000002,209.6546375,181.08,211.56144375,180C213.46824999999998,178.92,215.374925,179.28,217.28165625,178.56C219.1883875,177.84,221.09509999999997,175.44000000000003,223.00183124999998,175.68000000000004C224.9085625,175.92000000000004,226.81526875,177.6,228.72204375,180C230.62881875000002,182.4,232.53564375000002,188.76000000000005,234.44248125000001,190.08000000000004C236.34931875,191.40000000000003,238.25620937500003,188.99999999999997,240.16306875,187.91999999999996C242.069928125,186.83999999999995,243.976803125,184.92,245.8836375,183.6C247.79047187499998,182.28,249.69730937500003,180.84,251.60407500000002,180C253.51084062500001,179.16,255.41747187500002,179.04000000000002,257.32423125,178.56C259.230990625,178.07999999999998,261.1378375,176.87999999999994,263.04463125,177.11999999999995C264.95142500000003,177.35999999999996,266.85819687500003,178.07999999999998,268.76499375000003,180C270.671790625,181.92000000000002,272.57860625,187.56,274.4854125,188.64000000000001C276.39221875,189.72000000000003,278.29902500000003,187.68000000000004,280.20583125,186.48000000000005C282.1126375,185.28000000000006,284.0193875,182.52000000000004,285.92625,181.44000000000003C287.83311249999997,180.36,289.740090625,180.48000000000002,291.64700625,180C293.553921875,179.51999999999998,295.46088125,179.04000000000002,297.36774375,178.56C299.27460625,178.07999999999998,301.18138125,176.63999999999993,303.08818125,177.11999999999995C304.99498124999997,177.59999999999997,306.90175312499997,179.52,308.80854374999996,181.44000000000003C310.71533437499994,183.36000000000004,312.622115625,187.8,314.528925,188.64000000000001C316.43573437500004,189.48000000000002,318.34254375,187.32000000000005,320.2494,186.48000000000005C322.15625624999996,185.64000000000004,324.06320312500003,184.68,325.97006250000004,183.6C327.87692187500005,182.51999999999998,329.78375937500005,180.84,331.69055625000004,180C333.59735312500004,179.16,335.504046875,178.8,337.41084374999997,178.56C339.31764062499997,178.32,341.22450937499997,178.8,343.1313375,178.56C345.038165625,178.32,346.944996875,175.43999999999994,348.8518125,177.11999999999995C350.758628125,178.79999999999995,352.665459375,186.84,354.57223125,188.64000000000001C356.479003125,190.44000000000003,358.38572187499994,188.51999999999995,360.29244374999996,187.91999999999996C362.199165625,187.31999999999996,364.105753125,186.36,366.0125625,185.04000000000002C367.919371875,183.72000000000003,369.826365625,180.84,371.7333,180C373.640234375,179.16,375.547271875,180,377.45416875,180C379.36106562500004,180,381.267890625,180.24,383.17468125,180C385.081471875,179.76,386.9881,177.24,388.8949125,178.56C390.801725,179.88,392.7088,186.59999999999997,394.61555625,187.91999999999996C396.5223125,189.23999999999995,398.42880312500006,187.20000000000005,400.33545000000004,186.48000000000005C402.242096875,185.76000000000005,404.1486593750001,184.68,406.05543750000004,183.6C407.962215625,182.51999999999998,409.869175,180.6,411.77611874999997,180C413.68306249999995,179.4,415.59030312500005,180,417.49710000000005,180C419.40389687500004,180,421.31027500000005,180,423.2169,180C425.123525,180,427.030109375,178.32,428.93685,180C430.843590625,181.68,432.750621875,189.00000000000003,434.65734375,190.08000000000004C436.564065625,191.16000000000005,438.47054375,187.56000000000006,440.37718125,186.48000000000005C442.28381874999997,185.40000000000003,444.19039375,184.68,446.09716875000004,183.6C448.0039437500001,182.51999999999998,449.91104062500006,180.35999999999999,451.81783125000004,180C453.724621875,179.64000000000001,455.63118437500003,181.44000000000003,457.5379125,181.44000000000003C459.444640625,181.44000000000003,461.35146875,180.48000000000002,463.2582,180C465.16493125,179.51999999999998,467.0716,177.72,468.9783,178.56C470.885,179.4,472.791703125,183.48000000000002,474.69840000000005,185.04000000000002C476.6050968750001,186.60000000000002,478.51180625,188.15999999999997,480.41848125,187.91999999999996C482.32515625,187.67999999999995,484.2318125,184.92,486.13845,183.6C488.04508749999997,182.28,489.95164687500005,180.6,491.85830625000006,180C493.76496562500006,179.4,495.6716875,180,497.57840625,180C499.485125,180,501.39191875,180.48000000000002,503.29861875,180C505.20531875,179.51999999999998,507.11197500000003,176.51999999999995,509.01860625000006,177.11999999999995C510.9252375000001,177.71999999999994,512.8317937500001,181.67999999999998,514.73840625,183.6C516.64501875,185.52,518.551671875,188.16,520.45828125,188.64000000000001C522.364890625,189.12000000000003,524.2714125,187.92000000000004,526.1780625,186.48000000000005C528.0847125,185.04000000000005,529.9914125,181.32,531.89818125,180C533.80495,178.68,535.711828125,179.04000000000002,537.618675,178.56C539.5255218750001,178.07999999999998,541.4324625,177.11999999999995,543.3392625,177.11999999999995C545.2460625,177.11999999999995,547.1528000000001,178.32,549.059475,178.56C550.96615,178.8,552.872634375,177.24,554.7793125,178.56C556.6859906249999,179.88,558.592853125,185.16000000000003,560.49954375,186.48000000000005C562.406234375,187.80000000000007,564.312834375,186.96000000000006,566.21945625,186.48000000000005C568.126078125,186.00000000000003,570.0325125,184.68,571.9392750000001,183.6C573.8460375000001,182.51999999999998,575.75311875,181.08,577.66003125,180C579.56694375,178.92,581.4738593750001,177.59999999999997,583.38075,177.11999999999995C585.287640625,176.63999999999993,587.1946125,176.87999999999994,589.101375,177.11999999999995C591.0081375,177.35999999999996,592.9146125,177,594.821325,178.56C596.7280375,180.12,598.634928125,185.16000000000003,600.54165,186.48000000000005C602.448371875,187.80000000000007,604.3550124999999,187.32000000000005,606.26165625,186.48000000000005C608.1683,185.64000000000004,610.0748,184.32000000000005,611.9815125,181.44000000000003C613.888225,178.56,615.79510625,171,617.70193125,169.2C619.60875625,167.39999999999998,621.51561875,170.16000000000003,623.4224625,170.64000000000004C625.3293062500001,171.12000000000006,627.23613125,171.84000000000003,629.14299375,172.08000000000004C631.04985625,172.32000000000005,632.9568093749999,172.32000000000005,634.8636375,172.08000000000004C636.770465625,171.84000000000003,638.677,170.64000000000004,640.5839625,170.64000000000004C642.490925,170.64000000000004,644.398771875,171.84000000000003,646.3054125,172.08000000000004C648.212053125,172.32000000000005,650.11746875,172.08000000000004,652.02380625,172.08000000000004C653.9301437500001,172.08000000000004,655.836878125,172.08000000000004,657.7434375,172.08000000000004C659.649996875,172.08000000000004,661.556571875,172.08000000000004,663.4631625000001,172.08000000000004C665.3697531250001,172.08000000000004,667.276353125,172.32000000000005,669.18298125,172.08000000000004C671.089609375,171.84000000000003,672.9963,171.24000000000004,674.90293125,170.64000000000004C676.8095625000001,170.04000000000005,678.71616875,168.84000000000003,680.62276875,168.48000000000002C682.52936875,168.12,684.4358875,168.36,686.34253125,168.48000000000002C688.2491749999999,168.60000000000002,690.1559562499999,169.07999999999998,692.06263125,169.2C693.96930625,169.32,695.875934375,169.2,697.78258125,169.2C699.689228125,169.2,701.595828125,169.32,703.5025125,169.2C705.4091968749999,169.07999999999998,707.315984375,168.48000000000002,709.2226875,168.48000000000002C711.129390625,168.48000000000002,713.0360406249999,169.07999999999998,714.94273125,169.2C716.849421875,169.32,718.75609375,169.2,720.66283125,169.2C722.5695687499999,169.2,724.4764281250001,169.32,726.3831562500001,169.2C728.289884375,169.07999999999998,730.196553125,168.60000000000002,732.1032,168.48000000000002C734.009846875,168.36,735.9259625000001,168.36,737.8230375,168.48000000000002C739.7201125,168.60000000000002,741.5885250000001,169.68,743.4856500000001,169.2C745.382775,168.71999999999997,747.2990656249999,165.95999999999998,749.2057874999999,165.6C751.112509375,165.24,753.019271875,166.44000000000003,754.92598125,167.04000000000002C756.8326906249999,167.64000000000001,758.739375,168.95999999999998,760.64604375,169.2C762.5527125,169.44,764.4594124999999,168.60000000000002,766.3659937499999,168.48000000000002C768.272575,168.36,770.1789249999999,168.48000000000002,772.0855312499999,168.48000000000002C773.9921374999999,168.48000000000002,777.80563125,168.48000000000002,777.80563125,168.48000000000002"></path></g></svg>
	<script type="text/javascript">       
        //  Open a WebSocket to the server.
        //  Need a Regular Expression to get the URL to open the WebSocket to.
        const serverUrlRegex = /\d+\.\d+\.\d+\.\d+/; //  Matches 192.168.1.8 etc.
        const currentUrl = window.location.origin; //  Get the URL from the browser.
        console.log(`The currentURL is ${currentUrl}.`);
        const serverUrl = currentUrl.match(serverUrlRegex); //  Extract what is needed to create WebSocket.
        console.log(`The server URL is ${serverUrl[0]}`); //  The match is in the 0th element of the array.
        let ws = new WebSocket(`ws://${serverUrl}`);   //  Comment this for static URI.
        
        ws.onopen = () => {
            console.log('Web browser opened a WebSocket.');
            //  Update the connection status in the browser.
            connectstatus.textContent = "WebSocket Connected";
        }

        ws.onclose = () => {
            console.log('Web browser WebSocket just closed.');
            //  Update the connection status in the browser.
            connectstatus.textContent = "WebSocket is disconnected";
        }
        
        var parseTime = d3.timeParse("%I:%M");  //  12 Hour and Minute like  10:23
        let currentDate = new Date();
        let tempData = [];

        const xLabel = 'Time';
        const yLabel = 'Temperature';
        const margin = {
            left: 120,
            right: 30,
            top: 20,
            bottom: 120
        };

        const svg = d3.select('svg');
        const width = svg.attr('width');
        const height = svg.attr('height');
        const innerWidth = width - margin.left - margin.right;
        const innerHeight = height - margin.top - margin.bottom;

        const g = svg.append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`);
        const xAxisG = g.append('g')
            .attr('transform', `translate(0, ${innerHeight})`); // X axis group
        const yAxisG = g.append('g'); // Y axis group

        xAxisG.append('text')
            .attr('class', 'axis-label')
            .attr('x', innerWidth / 2)
            .attr('y', 50)
            .text(xLabel);

        yAxisG.append('text')
            .attr('class', 'axis-label')
            .attr('x', -innerHeight / 2)
            .attr('y', -45)
            .attr('transform', `rotate(-90)`)
            .style('text-anchor', 'middle')
            .text(yLabel);

        //  Accessor functions for x and y.
        const xValue = d => d.time;
        const yValue = d => d.temp;

//        const xScale = d3.scaleTime() // xValue is an accessor function defined way above.
//            .range([0, innerWidth]);
//   let currentDate = new Date();
        let currentPlus12 = d3.timeHour.offset(currentDate, 12);
        
let xScale = d3
		.scaleTime()
		.range([0, innerWidth])
    .domain([currentDate, currentPlus12]);

        const yScale = d3.scaleLinear()
        .domain([50,100])
            .range([innerHeight, 0]); //  Flippage of y-axis occurs here.
        //        .nice(yTicks);

        const line = d3.line(tempData)
            .x(d => xScale(+d.time))
            .y(d => yScale(+d.temp))
            .curve(d3.curveCardinal);
//            .curve(d3.curveBasis);

//        console.log(line);

// const DAY = 24*3600*1000
// let length = 10;
// let data = Array
// 	.from({length}, (e,i)=>i*DAY)
// 	.map(v=>new Date(v))
  


let xAxis = d3
	.axisBottom(xScale)
//  .ticks(d3.timeHour, 1)
  .tickFormat(d3.timeFormat("%I:%M"))


//         const xAxis = d3.axisBottom()
//             .scale(xScale)
//             .tickPadding(15)
//             .ticks(13)
//             .tickSize(-innerHeight);

        const yTicks = 10; // Will need more ticks for Fahrenheit.
        const yAxis = d3.axisLeft()
            .scale(yScale)
            .ticks(yTicks)
            .tickPadding(15)
            .tickSize(-innerWidth);

        //       const row = d => {
        //           d.timestamp = new Date(d.timestamp); //  Javascript Date type.
        //           d.temperature = +d.temperature; //  Funky + instead of parseInt.
        //            return d;
        //       };

        //  Update function.
        function update(objectArray) {
  //          g.remove('path');
            d3.selectAll("#tempData").remove();
            
//            xScale.domain(d3.extent(tempData, xValue));
//            yScale.domain(d3.extent(tempData, yValue));
//yScale.domain([50, 100]);
            
            g.append('path')
            .attr('id', 'tempData')
                .datum(objectArray) //  This does not "bind" any data.
                .attr('fill', 'none')
                .attr('stroke', 'steelblue')
                .attr('stroke-width', 4)
                .attr('d', line)
            .exit()
            .remove();
            xAxisG.call(xAxis);
            yAxisG.call(yAxis);
        };

        update(tempData);
        
               //  The following event-driven function removes the oldest data object, and adds the newest.
        //  The line chart is then updated with the newest data.
        //  Temporary hack until proper time added to x axis.
let counter = 7;
//  Clock is used both by the time display and on the X-axis of the chart.               
let clock = document.getElementById('currentTime');     
               
       ws.onmessage = (message) => {
            console.log(message.data);
            
            let statusMessage = JSON.parse(message.data);
            //  Check the message type and handle as required.
            if (statusMessage.messageType === "temperature") {
//  Remove the oldest object from the data.
                console.log(`wxData message received`)
//                tempData.shift();
//                let newTempData = {'time': clock, 'temp': +statusMessage.currentTemp}
                let currentDate = new Date();
let newTempData = {'time': currentDate, 'temp': +statusMessage.currentTemp};
                counter++;
                tempData.push(newTempData);
                //  Update chart.
                update(tempData);
            } else if (statusMessage.messageType === "schedule") {
                irrigationDate.textContent = 'Date: ' + statusMessage.scheduleDate;
                irrigationStart.textContent = 'Start: ' + statusMessage.scheduleStart;
                irrigationStop.textContent = 'Stop: ' + statusMessage.scheduleStop;
            } else if (statusMessage.messageType === "serverTime") {
                //  Current Server Time Updater.  Updated every 1 second by server.
//                let clock = document.getElementById('currentTime');
                let currentTime = new Date();
                console.log(currentTime);
                let hourMinuteFormat = d3.timeFormat("%H:%M");
                let hourMinute = hourMinuteFormat(new Date);
                console.log(`hour and minute ${hourMinute}`);
                clock.textContent = statusMessage.serverTime;
            }
        }

    </script>


</body></html>